<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CO₂ and CH₄ Emissions Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map {
            height: 600px;
        }

        .legend,
        .controls {
            background-color: white;
            padding: 10px;
            font-family: Arial, sans-serif;
            line-height: 1.5;
        }

        .legend h4 {
            margin: 0;
            font-size: 14px;
        }

        .legend div {
            margin-bottom: 4px;
        }

        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="controls">
        <label for="emissionType">Select Emission Type:</label>
        <select id="emissionType">
            <option value="co2">CO₂ Emissions</option>
            <option value="ch4">CH₄ Emissions</option>
        </select>
    </div>
    <div id="map"></div>
    <div id="legend" class="legend"></div>

    <script>
        // Initialize the map, centered globally
        var map = L.map('map').setView([20, 0], 2);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var currentLayer = null; // Store the reference to the current map layer

        // Function to determine circle color based on emissions severity
        function getColor(emissions) {
            return emissions > 350 ? 'red' :
                emissions > 330 ? 'orange' :
                    emissions > 300 ? 'yellow' :
                        'green';
        }

        // Function to calculate dynamic radius based on emissions data
        function getRadius(emissions) {
            return Math.sqrt(emissions) * 10000;  // Adjust scale as necessary
        }

        // Function to fetch data from a given JSON file
        function fetchData(jsonFile) {
            return fetch(jsonFile)
                .then(response => response.json())
                .then(data => data)
                .catch(error => console.error('Error loading JSON data:', error));
        }

        // Function to update the map circles based on the selected emissions type and dataset
        function updateMap(emissionType) {
            var jsonFile = emissionType === 'co2' ? 'co2_data.json' : 'ch4_data.json';

            fetchData(jsonFile).then(data => {
                // Remove the existing layer (if any)
                if (currentLayer) {
                    map.removeLayer(currentLayer);
                }

                // Create a new layer group for the selected emissions type
                var layerGroup = L.layerGroup();

                // Iterate over the data and place circles on the map
                data.forEach(function (entry) {
                    // Assuming the locations are hardcoded or come from another source, we will use some mock data for locations
                    var locations = [
                        { "lat": 37.7749, "lon": -122.4194 },  // San Francisco
                        { "lat": 34.0522, "lon": -118.2437 },  // Los Angeles
                        { "lat": 40.7128, "lon": -74.0060 },   // New York
                        { "lat": 51.5074, "lon": -0.1278 },    // London
                        { "lat": 35.6895, "lon": 139.6917 },   // Tokyo
                        { "lat": 48.8566, "lon": 2.3522 }      // Paris
                    ];

                    // Use the average field from the JSON as emissions data
                    var color = getColor(entry.average);
                    var radius = getRadius(entry.average);

                    L.circle([locations[data.indexOf(entry)].lat, locations[data.indexOf(entry)].lon], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.5,
                        radius: radius
                    }).bindPopup(`Year: ${entry.year}, Month: ${entry.month}, Emissions: ${entry.average} ppm`)
                        .addTo(layerGroup);
                });

                // Add the new layer group to the map
                layerGroup.addTo(map);
                currentLayer = layerGroup; // Store the reference to the current layer
            });
        }

        // Create a legend and add it to the map
        function addLegend() {
            var legend = L.control({ position: 'bottomright' });

            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'legend');
                div.innerHTML += '<h4>Emissions (ppm)</h4>';
                div.innerHTML += '<div><span style="background-color:red; width:12px; height:12px; display:inline-block;"></span> > 350 ppm</div>';
                div.innerHTML += '<div><span style="background-color:orange; width:12px; height:12px; display:inline-block;"></span> 330 - 350 ppm</div>';
                div.innerHTML += '<div><span style="background-color:yellow; width:12px; height:12px; display:inline-block;"></span> 300 - 330 ppm</div>';
                div.innerHTML += '<div><span style="background-color:green; width:12px; height:12px; display:inline-block;"></span> < 300 ppm</div>';
                return div;
            };

            legend.addTo(map);
        }

        // Call the legend creation function
        addLegend();

        // Listen to changes in the dropdown and update the map
        document.getElementById('emissionType').addEventListener('change', function () {
            var selectedType = this.value;
            updateMap(selectedType); // Update the map based on the selected type
        });

        // Initially load the map with CO₂ data
        updateMap('co2');
    </script>
</body>

</html>